---
layout: blog
title: 销售占用库存
---

#{{page.title}}

关于odoo占用库存

占用库存是一个常见的ERP功能， 
## 问题背景

这两天在给深圳一家批发业务为主的公司上线ERP，在销售部分，碰到了这样一个常见的问题。他们的不同销售人员下单的时候，会争抢库存，销售人员A检查库存时还有货，正常下单；然后，销售人员B下单，由于库存并未发出，检查库存时也有货，正常下单。最后B的订单先发货，发完后，库存不够，A单无法正常发出，发期延迟，客户不满。

总结下问题，如何给一个客户一张销售订单占用库存，保证其他客户下单的时候不会动用这批库存？

## odoo占用库存
odoo没有严格意义上的销售订单占用库存；新版V8，在仓库发货单以及其他移库单上，有分配库存的功能。第二点，销售订单上，选择产品时，会检查产品的库存，缺货时会提醒没有库存。
我们可以使用以上两点，为一张订单一个客户占用OE库存。

0. 产品 “手机1” 在深圳仓库 100件。
1. 销售A下单 SO1001，产品 “手机1” 80。 确认审核，生产发货单 DO1001。
2. 仓库收到DO1001， 检查库存，占用产品“手机1” 80。 “手机1” 库存依然100。
3. 销售B下单 SO1003， 产品 “手机1” 50。 收到提醒， 产品在售库存100， 已分配 80， 还剩20。

这边有几个问题, 我们需要深入：

* V8中如何分配库存
* 销售下单时，查看的是哪几个库存


### V8中如何分配库存
V8 中有新概念，stock.quant （库存包），库存包可以分配给一个partner (伙伴)。
发货单上，点击检查库存时， 系统会检查当前可用库存，给现有的库存数量在当前库位产生一个新的库存包，并分配给客户，分配完之后，库存不可用。
举例， “手机1” 深圳仓库 100件。DO1001，“手机1” 出库80件。检查库存后，系统会生产一个库存包， 数量80，在 深圳仓库。


### 销售下单时，查看的是哪几个库存
销售订单下单时，系统会比较产品的默认虚拟库存，和销售数量。

默认虚拟库存怎么计算？
默认虚拟库存统计所有仓库的视图仓库库位 (view_location_id)的库存。

不足之处，或者说是bug

* 销售订单查看库存时，并未比较指定仓库的未来库存。
* 仓库库位设置，即使打开高级路由之后，仍无法配置。
* 采购数量会统计到虚拟库存中，对于采购周期较长无法用来销售的 用户来说，无法接受。而且采购下单，只能直接下到仓库的默认库存库位，无法下到入库库位。配置两步收货路由后，依然不行。


### 不足
* 缺货时，只有销售提醒，不能完全阻止下单。
* 需要仓库人员操作后，才能
* 销售订单查看库存时，无法比较指定仓库的未来库存。
* 仓库库位设置，即使打开高级路由之后，仍无法配置。
* 采购数量会统计到虚拟库存中，对于采购周期较长无法用来销售的 用户来说，无法接受。而且采购下单，只能直接下到仓库的默认库存库位，无法下到入库库位。配置两步收货路由后，依然不行。



## 其他思路
扩展warning 模块。
warning模块可以在产品上设置销售订单提醒或阻止。扩展时可以设置python语法条件，根据条件进行提醒或阻止。通过编辑合适的条件，例如 查看可用库存的未占用库存，也能解决此问题。
这个方法的好处是，可以完全阻止下单。

## [寰享科技(深圳) 正在招聘 初级/高级odoo 技术工程师][job_link]
[job_link]: http://simple-is-better.com/jobs/866 "Eilco Shenzhen hire odoo developers"
